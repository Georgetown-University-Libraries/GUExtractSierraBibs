This code provides a sample implementation of a BIB and ITEM extract using the [Sierra REST API](https://sandbox.iii.com/docs/).

This code has been shared for illustrative purposes.  Some of this code contains institution-specific logic.
- formatting of the $945 element
- naming conventions for output files
- filter criteria for output files
 
### Purpose
The Georgetown University Libraries provide quarterly, monthly, and daily extracts our catalog data to the Washington Regional Library Consortium (WRLC).  Prior to the creation of this program, these files were generated by our Systems Librarian using Sierra client functionality.  This program was written in order to reduce the staff time required to produce these data files and to increase the frequency of delivery of these files.

Types of extracts:
- Deletes - bibs deleted on the prior business day
- Adds - bibs added on the prior business day
- Updates - bibs updated on the prior business day
- Adds or Updates - bibs either added or updated on the prior business day
- All - full catalog extract

The full catalog extract process will need to execute over a period of several business days during off-peak hours.  The system has been designed to batch ad continue this process.

### Installation
- Marc4j library page: https://github.com/marc4j/marc4j
- Download marc4j-2.6.0.jar file from https://github.com/marc4j/marc4j/tree/master/releases
- Load the jar file to your local mvn repository
- `mvn install:install-file -Dfile=marc4j-2.6.0.jar -DgroupId=marc4j -DartifactId=marc4j -Dversion=2.6.0 -Dpackaging=jar`
- Clone this repository
- Run mvn install
- Edit config/api.cfg
- Set up the cron

### Configuration
Customize config file *config/api.cfg*

Config file template:
```
# Path to runtime directory
# ROOTDIR: /var/data/my-program
ROOTDIR:

# URL for Sierra API Service
# APIROOT: https://sandbox.iii.com/iii/sierra-api/v1/
# APIROOT: https://https://YOUR.SIERRA.SERVICE.EDU/iii/sierra-api/v1/
APIROOT:

# Creating API credentials
# https://YOUR.SIERRA.ADMIN.SERVICE.EDU/sierra/admin/help/Default.htm#sadmin/sadmin_other_webapps_api.html
CLIENT_KEY:
CLIENT_SECRET:

# Location File: 
# The Sierra API does not currently return bib locations, the following mapping file will map item loc to bib loc
# A comma delimited file containing 1.item location code 2.location name (not used) 3. bib location code
# Query to reconstruct this file:
LOCATION_CODE_FILE: data/locations.txt

```

### System Directory Structure
```
ROOTDIR
  /config - system configuration files
    api.cfg
  /data
    location.txt
    /output
      /<target> - target consumer of generated files 
        /<date>
          <file>.mrc - generated file of relevant bib records
    /queue
      /compelete - record of completed tasks
        <QueryType>.<date>.txt 
      /resume - for processes that will span multiple days, save the state of the running process
        <QueryType>.<date>.cfg
      /running - indicator that a process is running, no other processes should run at the same time
        <QueryType>.<date>.cfg
  /lib
    *.jar - system jar files
```

### Sample Queue File Structure
```
# Runtime Parameters
#   QueryType: query being executed 
#              ALL|ADDED|UPDATED|DELETED|ADDED_OR_UPDATED
#   endDate: YYYYMMDD, end date for query
#   days: 1, days to include in query
#   LastBib: last Bib Id number processed
# -------------------------------------------------------
QueryType: ADDED
endDate: YYYYMMDD
days: 1
LastBib: -1

# Statistics
# ----------
Total Bibs:    325
Total Items:   740
Total Time:    141875ms
Total Time/Bib 436ms
Total Time/Bib&Item 133ms

# Counts By File (files listed will depend on query type)
# -------------------------------------------------------
WrlcCatalog\20140718\DAUPDATE.mrc                 : 17
WrlcCatalog\20140718\GTUPDATE.mrc                 : 299
NoMatch                                           : 9



```

### Runtime Parameters
```
-q QueryType -start [-end <endDate>] [-days <numberOfDays>] [-maxTime <minutes>] -config configFile
-q QueryType -resume [-maxTime <minutes>] -config configFile

          -q QueryType: ALL|ADDED|UPDATED|DELETED|ADDED_OR_UPDATED|DAILY
                        DAILY: cycles through ADDED, UPDATED, DELETED, and ADDED_OR_UPDATED
    -config configFile: Path to the configuration file
                -start: Start a new query task
               -resume: Resume processing a query task if a resume file exists
        -end <endDate>: End date for current query in YYYYMMDD format (not applicable for ALL)
                        Default to current date
  -days <numberOfDays>: Integer, used to calculate start date for current query (not applicable for ALL)
                        Default to 1
    -maxTime <minutes>: Number of minutes to run the process.  
                        If the process does not complete in time, a resume file will be generated
```

### Sample Cron Schedule
```
# Daily processes
0 18 * * * java -jar GUExtractSierraBibs-1.0.jar DAILY -start
# Monthly processes, start the full dump on the first of the month
0 19 1 * * java -jar GUExtractSierraBibs-1.0.jar ALL -start -maxTime 300
# Resume the monthly dump nightly for 5 hours per night until completed
5 19 * * * java -jar GUExtractSierraBibs-1.0.jar ALL -resume -maxTime 300
```


# License
License information is contained below.

Copyright (c) 2014, Georgetown University Libraries All rights reserved.

Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:

Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer. 
in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials 
provided with the distribution. THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, 
BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. 
IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES 
(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) 
HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) 
ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
